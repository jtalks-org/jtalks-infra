#!/bin/bash
#
# pochta mail trap service
#
# chkconfig: 35 99 01
# description: pochta service captures incoming mails and makes them available via REST
# processname: pochta
#
# Usage:
#
# 1. change pochta.jar location below to point on your Pochta installation
# 2. place this script in /etc/init.d
# 3. make it executable: 'sudo chmod 755 /etc/init.d pochta'
# 4. service is installed, you can control it with 'service pochta start | stop | restart'
#

set -u

USER=<%= @user %>
GROUP=<%= @user %>
BIN_PATH=<%= @bin_path %>
PID_FILE=/var/run/<%= @service_name %>/pid
JAVA_BIN=$(which java)

start() {
    start-stop-daemon --start -b --user "$USER" --group "$GROUP" --pidfile "$PID_FILE" --exec "$JAVA_BIN" -- -jar "$BIN_PATH"

    status="$?"
    set +a -e
    echo "Status $status"
}

stop() {
    if [ -f $PID_FILE ];
    then
        echo 'Stopping Pochta service...'
        start-stop-daemon --stop --pidfile "$PID_FILE"  --user "$USER"  --retry=TERM/20/KILL/5 >/dev/null
        echo 'Service stopped'
    else
        echo 'Pochta service is not running, ignoring STOP command'
    fi
}

case $1 in
    start)
        start
    ;;
    stop)
        stop
    ;;
    restart | reload)
        stop
        start
    ;;
esac
exit 0